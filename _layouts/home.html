---
layout: default
refactor: true
---
{%- comment -%}
  Custom home layout for Chirpy-based blog (113bommy.github.io)
  Features added:
    1. Hero/intro section pulling data from _config.yml (title, description, avatar).
    2. "최근 포스트" grid – latest 4 posts with auto‑detected thumbnails (first image in post) or fallback.
    3. Interactive treemap of categories (size = number of posts) built with D3 v7.
  Place this file under your repository’s `_layouts` folder; pages whose front-matter says `layout: home` (e.g. index.html / index.md) will automatically use it.
{%- endcomment -%}
<!DOCTYPE html>
<html lang="{{ page.lang | default: site.lang | default: 'en' }}">
  {%- include head.html -%}
  <body>
    {%- include sidebar.html -%}
    <div class="page-wrapper d-flex flex-column">
      {%- include topbar.html -%}

      <main class="flex-fill">
        <!-- ▣ 1. INTRO ------------------------------------------------------ -->
        <section id="home-intro" class="text-center py-5 container">
          <img src="{{ site.avatar | default: '/assets/img/avatar.png' | relative_url }}" class="rounded-circle mb-3 shadow" style="width:120px;height:120px;object-fit:cover;" alt="avatar">
          <h1 class="h3 fw-bold mb-1">{{ site.title }}</h1>
          <p class="lead mb-0">{{ site.tagline | default: site.description }}</p>
        </section>

        <!-- ▣ 2. RECENT POSTS ------------------------------------------------ -->
        <section id="recent-posts" class="py-5 bg-body-tertiary">
          <div class="container">
            <h2 class="h4 fw-semibold mb-4">최근 포스트</h2>
            <div class="row g-4">
              {%- assign recent_posts = site.posts 
                    | where_exp: "p","p.hidden != true" 
                    | where_exp: "p","p.draft != true" 
                    | sort: 'date' | reverse | slice: 0,4 -%}
              {%- for post in recent_posts -%}
              {%- comment -%}
                ▸ 썸네일 선정 우선순위
                  1. front‑matter `img_path`
                  2. 첫 번째 마크다운 이미지 ![...](url)
                  3. `/assets/img/default-thumbnail.webp`
              {%- endcomment -%}

              {%- assign thumb = nil -%}
              {%- if post.img_path -%}
                {%- assign thumb = post.img_path | relative_url -%}
              {%- else -%}
                {%- capture raw %}{{ post.content | strip_newlines }}{%- endcapture -%}
                {%- if raw contains '!['] -%}
                  {%- assign seg = raw | split: '!['] -%}
                  {%- assign seg2 = seg[1] | split: '(' -%}
                  {%- if seg2.size > 1 -%}
                    {%- assign seg3 = seg2[1] | split: ')' -%}
                    {%- assign first_img = seg3[0] -%}
                    {%- assign thumb = first_img | strip -%}
                  {%- endif -%}
                {%- endif -%}
              {%- endif -%}
              {%- if thumb == nil or thumb == '' -%}
                {%- assign thumb = `/assets/img/Placeholder_view.png` | relative_url -%}
              {%- endif -%}

              <div class="col-12 col-sm-6 col-lg-3">
                <a href="{{ post.url | relative_url }}" class="card h-100 border-0 shadow-sm text-decoration-none">
                  <img src="{{ thumb }}" class="card-img-top" style="object-fit:cover;height:160px;" alt="{{ post.title }} thumbnail">
                  <div class="card-body">
                    <h3 class="card-title h6 mb-1 fw-bold text-dark">{{ post.title }}</h3>
                    <p class="card-text small text-muted mb-0">{{ post.date | date: '%Y-%m-%d' }}</p>
                  </div>
                </a>
              </div>
              {%- endfor -%}
            </div>
          </div>
        </section>

        <!-- ▣ 3. CATEGORY TREEMAP ------------------------------------------- -->
        <section id="category-section" class="py-5 container">
          <h2 class="h4 fw-semibold mb-4">카테고리</h2>
          <div id="treemap" style="height:520px;position:relative;"></div>
        </section>
      </main>

      {%- include footer.html -%}
    </div>

    <!-- ▣ D3 Treemap script ------------------------------------------------- -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const data = {
          name: "categories",
          children: [
            {% assign cats = site.categories %}
            {% for cat in cats %}
              { name: "{{ cat[0] | slugify }}", label: "{{ cat[0] }}", value: {{ cat[1].size }} }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        };

        const container = document.getElementById('treemap');
        if (!container || data.children.length === 0) return;

        const width  = container.getBoundingClientRect().width || window.innerWidth - 48;
        const height = container.getBoundingClientRect().height || 500;

        const root = d3.treemap()
          .size([width, height])
          .paddingInner(4)
          (d3.hierarchy(data).sum(d => d.value));

        const color = d3.scaleOrdinal(d3.schemeCategory10);

        const div = d3.select(container);

        const nodes = div.selectAll('div.tnode')
          .data(root.leaves())
          .enter().append('div')
            .attr('class','tnode')
            .style('position', 'absolute')
            .style('left', d => d.x0 + 'px')
            .style('top',  d => d.y0 + 'px')
            .style('width', d => Math.max(0, d.x1 - d.x0) + 'px')
            .style('height', d => Math.max(0, d.y1 - d.y0) + 'px')
            .style('background', (d,i) => color(i))
            .style('border-radius', '6px')
            .style('overflow', 'hidden')
            .style('cursor', 'pointer')
            .style('opacity',.85)
            .on('mouseover', function(){ d3.select(this).style('opacity',1); })
            .on('mouseout',  function(){ d3.select(this).style('opacity',.85); })
            .on('click', (e,d) => {
              window.location.href = '{{ site.baseurl | default: "" }}/categories/' + d.data.name + '/';
            });

        nodes.append('span')
          .style('display','block')
          .style('padding','6px')
          .style('font-size','0.85rem')
          .style('color','#000')
          .style('font-weight','600')
          .style('line-height','1.2')
          .text(d => d.data.label + ' (' + d.data.value + ')');
      });
    </script>

    {%- include search-loader.html -%}
  </body>
</html>
